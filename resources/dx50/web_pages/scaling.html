<!DOCTYPE HTML>
<html><head> 
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Scaling - Bitronics Web Server</title> 
    <link rel="stylesheet" type="text/css" href="site.css">
    <link rel="icon" href="favicon.ico">
    
    <style type="text/css"> 
    
    
input[type="file"] {
    display: none;
}
.custom-file-upload {
    border: 1px solid #ccc;
    display: inline-block;
    padding: 3px 7px;
    cursor: pointer;
    font-size: 13px;
    background: #dddddd;
    border-top: 1px solid #CCCCCC;
    border-right: 1px solid #333333;
    border-bottom: 1px solid #333333;
    border-left: 1px solid #CCCCCC;
}
    
    
    
    
    html {
  -ms-overflow-style: -ms-autohiding-scrollbar;
}
    
 
.fixed_header{
/*    width: 100%;*/
/*    table-layout: fixed;*/
    border-collapse: collapse;
}

.fixed_header tbody{
  overflow: auto;
  height: 170px;
  display: block;
}

.fixed_header thead {
  display: block;
}

input{
	width: 145px !important;
}

.fixed_header th, .fixed_header td {
	width: 149px !important;
  padding: 3px;
  text-align: left;
/*  width: 200px;*/
}
    </style>
    
    <script src="request.js"></script>
    <script src="content.js"></script>
    <script src="scaling.js"></script>
    <script src="djv.js"></script>

    
</head>
<body>
<div id="Content"></div>

<div class="pagebox" id="page">
<noscript><a class="noscript">This page requires Javascript.</a></noscript>

<div id="trail"><a href="settings.html">Settings</a> / Scaling</div>
<div id="message"></div>

<h2>Scalings</h2>

<table class="fixed_header" id="scaling_tbl" cellspacing="0" border="0">
	<thead>
		<tr>
		    <th class="label2">Name</th>
		    <th class="label2">P1 Poll</th>
		    <th class="label2">P1 Show</th>
		    <th class="label2">P2 Poll</th>
		    <th class="label2">P2 Show</th>
		    <!--<td class="label2"></td>-->
		</tr>
	</thead>
</table>

<hr style="width: 110.5%;">

<p style=" width:100%; text-align: left; margin-bottom: 0px; display:inline-block;">
<label style="margin-right: 37%;" for="jsonFile" class="custom-file-upload">Open Scaling File</label>
<input style="" id="jsonFile" type="file" />
<button onclick="addField();">Insert row</button>
</p>
<br/><button onclick="saveFile();">Save Scaling File</button>

<br><br/>

<p style="margin-top: 0px;" >
<button onclick="serialize();">Apply</button>
</p>

<form action="http:restore.cgi" method="POST" name="dflts" id="dflts" onsubmit="return get_resp()">
<input type="hidden" name="dflt" id="dflt" value="scaling"/>
<input type="submit" name="restore" value="Restore Defaults" />
</form>
</div>
<div class="pagebox"><div id="footer"></div></div>
    <script>
//<!--
//Load scaling from a Json file
document.getElementById('jsonFile').addEventListener('change', onChange);


function onChange(event) {
	
		 var ext = this.value.match(/\.([^\.]+)$/)[1];
		 if(ext == 'json'){
		 	var reader = new FileReader();
	        reader.readAsText(event.target.files[0]);
	        reader.onload = onReaderLoad;
		 }else{
		 	alert('Only Json files are allowed');
		 	this.value = '';
		 }        
    }

    function onReaderLoad(event){
    	
    	//async json schema fetch
    	fetch('FlexScale.schema.json')
    	.then(function(resp){
    		return resp.json();
    	})
    	.then(function(data){
    		
    		jsonSchema = {};
    		jsonSchema = data;
    		
    		//getting json from file, parsing and validating it
    		var obj = JSON.parse(event.target.result);
	        validation = validateJson(obj, jsonSchema);
	        
	        if(validation == undefined){ // file is valid
	        
	        	//convert to scaling objects 
				scalingNames = Object.getOwnPropertyNames(obj.scalings);
				//console.log(scalingNames[0]);
				
				slpoff = [];
				for (scl of scalingNames) {
			        slpoff.push(slpoff_from_points(new Scaling(scl, [[obj.scalings[scl][0][0], obj.scalings[scl][0][1]], [obj.scalings[scl][1][0], obj.scalings[scl][1][1]]])));
			        //console.log(obj.scalings[scl][0][0]);
			    }
				
				payload = JSON.stringify(slpoff);
				
				//remove tbody
				var table = document.getElementById('scaling_tbl');
				var row = document.getElementsByTagName('tbody')[0];
				    row.parentNode.removeChild(row);

				//create tbody
				parse_vars(payload);
				
				
			} else{
				alert("Invalid Json file");
			}
	        		
			//Unload file input
			document.getElementById('jsonFile').value = "";
    		
    	})
    		
    }


//Validate json against json schema
function validateJson(json, schema){
	const env = new djv();

	env.addSchema('test', schema);
	errors = env.validate('test#/scalings', json);
	
	return errors;
}





//Save scalings to a Json file
function saveFile() {

    // Build a list of each scaling row in the table
    var scaling_tbl = id('scaling_tbl');
    var scaling_lst = scaling_tbl.querySelectorAll("[flexscaling]");

    // keep the scaling data in an object and then jsonify it.
    var obj = {};
    var scalings = {};
    for (scr of scaling_lst) {
    	scalings[scr.flexscaling.nm] = [];
		scalings[scr.flexscaling.nm].push([parseInt(scr.flexscaling.x1), scr.flexscaling.y1]);
		scalings[scr.flexscaling.nm].push([parseInt(scr.flexscaling.x2), scr.flexscaling.y2]);
    }
    obj.scalings = scalings;
    
    var payload = JSON.stringify(obj);
    
    //console.log(payload);

	download(payload, 'scalings.json','application/json');

}


function download(text, name, type)
    {
        var file = new Blob([text], {type: type});
        var isIE = /*@cc_on!@*/false || !!document.documentMode;
        if (isIE)
        {
            window.navigator.msSaveOrOpenBlob(file, name);
        }
        else
        {
            var a = document.createElement('a');
            a.href = URL.createObjectURL(file);
            a.download = name;
            a.dispatchEvent(new MouseEvent('click', {bubbles: true, cancelable: true, view: window}));
        }
     }




window.SomeDeleteRowFunction = function SomeDeleteRowFunction(o) {
     var p=o.parentNode.parentNode;
     p.parentNode.removeChild(p);
}


 function addField (argument) {
            var myTable = document.getElementById("tablebody");
            var currentIndex = myTable.rows.length;
            var currentRow = myTable.insertRow(-1);

            var name = document.createElement("input");
            name.setAttribute("name", "nm");
            name.setAttribute('maxlength', 16);
            
            var p1poll = document.createElement("input");
            p1poll.setAttribute("name", "x1");
            p1poll.setAttribute('maxlength', 6);          

            var p1show = document.createElement("input");
            p1show.setAttribute("name", "y1");
            p1show.setAttribute('maxlength', 6);
             
            var p2poll = document.createElement("input");
            p2poll.setAttribute("name", "x2");
            p2poll.setAttribute('maxlength', 6);
            
            var p2show = document.createElement("input");
            p2show.setAttribute("name", "y2");
            p2show.setAttribute('maxlength', 6);
      
            /*var keywordsBox = document.createElement("input");
            keywordsBox.setAttribute("name", "keywords" + currentIndex);*/

            var deleteRowBox = document.createElement("input");
            deleteRowBox.setAttribute("type", "button");
            deleteRowBox.setAttribute("value", "Delete Row");
            deleteRowBox.setAttribute("onclick", "SomeDeleteRowFunction(this);");
            deleteRowBox.setAttribute("class", "button");
            deleteRowBox.setAttribute("style", "width: 85px !important;");
            

            currentRow.setAttribute("flexscaling", true);
            currentRow.flexscaling = new Scaling('', [[0, 0], [0, 0]]);
            
            var currentCell = currentRow.insertCell(-1);
            name.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(name);

            currentCell = currentRow.insertCell(-1);
            p1poll.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p1poll);

            currentCell = currentRow.insertCell(-1);
            p1show.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p1show);
            
            currentCell = currentRow.insertCell(-1);
            p2poll.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p2poll);

            currentCell = currentRow.insertCell(-1);
            p2show.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p2show);

            currentCell = currentRow.insertCell(-1);
            currentCell.appendChild(deleteRowBox);
        }


function update_scaling_onblur(scl) {
    function inner_handler(evt) {
        scl.flexscaling[evt.target.name] = evt.target.value;
    }
    return inner_handler
}

function parse_vars(data) {
    console.log("cgi response", data);
    
    // Create a table row with scaling object attached
    function createScalingRow(pts) {
    	
        function inner(scl, item, length) {
            td = document.createElement('td');
            ti = document.createElement('input');
            ti.setAttribute('name', item);
            ti.setAttribute('maxlength', length);
            ti.value = scl.flexscaling[item];
            ti.onblur = update_scaling_onblur(sr);
            td.appendChild(ti);
            return td;
        }
        
        var sr = document.createElement('tr');
        sr.setAttribute('flexscaling', true);   // for queryselect
        sr.flexscaling = pts;
        sr.appendChild(inner(sr, "nm", 16));
        sr.appendChild(inner(sr, "x1", 6));
        sr.appendChild(inner(sr, "y1", 6));
        sr.appendChild(inner(sr, "x2", 6));
        sr.appendChild(inner(sr, "y2", 6));
        
        
        //Delete button
                	
        	var deleteButton = document.createElement("input");
            deleteButton.setAttribute("type", "button");
            deleteButton.setAttribute("value", "Delete Row");
            deleteButton.setAttribute("onclick", "SomeDeleteRowFunction(this);");
            deleteButton.setAttribute("class", "button");
            deleteButton.setAttribute("style", "width: 85px !important; padding.right: 10px;");
            
	        var deleteButtonTd = document.createElement('td');
	        deleteButtonTd.appendChild(deleteButton);
	        
	        sr.appendChild(deleteButtonTd);
        	
        return sr;
        
    }
    
    // Locate the table and append reach scaling as a row
    var scaling_tbl = id('scaling_tbl');
    var tb = document.createElement('tbody');
    tb.setAttribute('id', 'tablebody');
    var scaling_lst = JSON.parse(data).scalings;
    for (scl of scaling_lst) {
			//console.log(points_from_slpoff(scl));
			tb.appendChild(createScalingRow(points_from_slpoff(scl)));	
    }
    
    scaling_tbl.appendChild(tb);
    
}

function serialize() {

    // Build a list of each scaling row in the table
    var scaling_tbl = id('scaling_tbl');
    var scaling_lst = scaling_tbl.querySelectorAll("[flexscaling]");

    // Convert the format of each scaling and serialize the list of scalings
    scl = [];
    for (scr of scaling_lst) {
    	//console.log(slpoff_from_points(scr.flexscaling));
        scl.push(slpoff_from_points(scr.flexscaling));
    }
    var payload = JSON.stringify(scl);

    // browser compat?
    var xhr = new XMLHttpRequest();
    xhr.open("PUT", "flex/scalings", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            console.log(xhr.response);
        }
    };
    xhr.send(payload);
}

function load_once() {
    populate("settings.html");
    makeRequest(nc("flex/scalings"), null);
}

window.onload=load_once;
//-->
</script>
</body></html>
