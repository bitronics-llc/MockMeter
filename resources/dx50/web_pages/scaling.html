<!DOCTYPE HTML>
<html><head> 
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <title>Scaling - Bitronics Web Server</title> 
    <link rel="stylesheet" type="text/css" href="site.css">
    <link rel="icon" href="favicon.ico">
    
    <style type="text/css"> 
    
    html {
  -ms-overflow-style: -ms-autohiding-scrollbar;
}
    
 
.fixed_header{
/*    width: 100%;*/
/*    table-layout: fixed;*/
    border-collapse: collapse;
}

.fixed_header tbody{
  overflow: auto;
  height: 170px;
  display: block;
}

.fixed_header thead {
  display: block;
}

input{
	width: 145px !important;
}

.fixed_header th, .fixed_header td {
	width: 149px !important;
  padding: 3px;
  text-align: left;
/*  width: 200px;*/
}
    </style>
    
    <script src="request.js"></script>
    <script src="content.js"></script>
    <script src="scaling.js"></script>
    <script>
//<!--


window.SomeDeleteRowFunction = function SomeDeleteRowFunction(o) {
     var p=o.parentNode.parentNode;
     p.parentNode.removeChild(p);
}


 function addField (argument) {
            var myTable = document.getElementById("tablebody");
            var currentIndex = myTable.rows.length;
            var currentRow = myTable.insertRow(-1);

            var name = document.createElement("input");
            name.setAttribute("name", "nm");
            name.setAttribute('maxlength', 16);
            
            var p1poll = document.createElement("input");
            p1poll.setAttribute("name", "x1");
            p1poll.setAttribute('maxlength', 6);          

            var p1show = document.createElement("input");
            p1show.setAttribute("name", "y1");
            p1show.setAttribute('maxlength', 6);
             
            var p2poll = document.createElement("input");
            p2poll.setAttribute("name", "x2");
            p2poll.setAttribute('maxlength', 6);
            
            var p2show = document.createElement("input");
            p2show.setAttribute("name", "y2");
            p2show.setAttribute('maxlength', 6);
      
            /*var keywordsBox = document.createElement("input");
            keywordsBox.setAttribute("name", "keywords" + currentIndex);*/

            var deleteRowBox = document.createElement("input");
            deleteRowBox.setAttribute("type", "button");
            deleteRowBox.setAttribute("value", "Delete Row");
            deleteRowBox.setAttribute("onclick", "SomeDeleteRowFunction(this);");
            deleteRowBox.setAttribute("class", "button");
            deleteRowBox.setAttribute("style", "width: 85px !important;");
            

            currentRow.setAttribute("flexscaling", true);
            currentRow.flexscaling = new Scaling('', [[0, 0], [0, 0]]);
            
            var currentCell = currentRow.insertCell(-1);
            name.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(name);

            currentCell = currentRow.insertCell(-1);
            p1poll.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p1poll);

            currentCell = currentRow.insertCell(-1);
            p1show.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p1show);
            
            currentCell = currentRow.insertCell(-1);
            p2poll.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p2poll);

            currentCell = currentRow.insertCell(-1);
            p2show.onblur = update_scaling_onblur(currentRow);
            currentCell.appendChild(p2show);

            currentCell = currentRow.insertCell(-1);
            currentCell.appendChild(deleteRowBox);
        }




function update_scaling_onblur(scl) {
    function inner_handler(evt) {
        scl.flexscaling[evt.target.name] = evt.target.value;
    }
    return inner_handler
}

function parse_vars(data) {
    // console.log("cgi response", data);
    
    // Create a table row with scaling object attached
    function createScalingRow(pts) {
        function inner(scl, item, length) {
            td = document.createElement('td');
            ti = document.createElement('input');
            ti.setAttribute('name', item);
            ti.setAttribute('maxlength', length);
            ti.value = scl.flexscaling[item];
            ti.onblur = update_scaling_onblur(sr);
            td.appendChild(ti);
            return td;
        }
        var sr = document.createElement('tr');
        sr.setAttribute('flexscaling', true);   // for queryselect
        sr.flexscaling = pts;
        sr.appendChild(inner(sr, "nm", 16));
        sr.appendChild(inner(sr, "x1", 6));
        sr.appendChild(inner(sr, "y1", 6));
        sr.appendChild(inner(sr, "x2", 6));
        sr.appendChild(inner(sr, "y2", 6));
        
        
        //Delete button
                	
        	var deleteButton = document.createElement("input");
            deleteButton.setAttribute("type", "button");
            deleteButton.setAttribute("value", "Delete Row");
            deleteButton.setAttribute("onclick", "SomeDeleteRowFunction(this);");
            deleteButton.setAttribute("class", "button");
            deleteButton.setAttribute("style", "width: 85px !important; padding.right: 10px;");
            
	        var deleteButtonTd = document.createElement('td');
	        deleteButtonTd.appendChild(deleteButton);
	        

	        sr.appendChild(deleteButtonTd);
        	
        
        
        
        
        
        return sr;
        
    }
    
    // Locate the table and append reach scaling as a row
    var scaling_tbl = id('scaling_tbl');
    var tb = document.createElement('tbody');
    tb.setAttribute('id', 'tablebody');
    var scaling_lst = JSON.parse(data);
    for (scl of scaling_lst) {
        tb.appendChild(createScalingRow(points_from_slpoff(scl)));
    }
    
    scaling_tbl.appendChild(tb);
    
}

function serialize() {

    // Build a list of each scaling row in the table
    var scaling_tbl = id('scaling_tbl');
    var scaling_lst = scaling_tbl.querySelectorAll("[flexscaling]");

    // Convert the format of each scaling and serialize the list of scalings
    scl = [];
    for (scr of scaling_lst) {
    	//console.log(scr.flexscaling);
        scl.push(slpoff_from_points(scr.flexscaling));
    }
    var payload = JSON.stringify(scl);

    // browser compat?
    var xhr = new XMLHttpRequest();
    xhr.open("PUT", "flex/scalings", true);
    xhr.setRequestHeader("Content-Type", "application/json");
    xhr.onreadystatechange = function () {
        if (xhr.readyState === 4 && xhr.status === 200) {
            console.log(xhr.response);
        }
    };
    xhr.send(payload);
}

function load_once() {
    populate("settings.html");
    makeRequest(nc("flex/scalings"), null);
}

window.onload=load_once;
//-->
</script>
    
</head>
<body>
<div id="Content"></div>

<div class="pagebox" id="page">
<noscript><a class="noscript">This page requires Javascript.</a></noscript>

<div id="trail"><a href="settings.html">Settings</a> / Scaling</div>
<div id="message"></div>

<h2>Scalings</h2>

<table class="fixed_header" id="scaling_tbl" cellspacing="0" border="0">
	<thead>
		<tr>
		    <th class="label2">Name</th>
		    <th class="label2">P1 Poll</th>
		    <th class="label2">P1 Show</th>
		    <th class="label2">P2 Poll</th>
		    <th class="label2">P2 Show</th>
		    <!--<td class="label2"></td>-->
		</tr>
	</thead>
</table>


<p style="text-align: center; margin-bottom: 0px;">
<button onclick="addField();">Insert row</button>
</p>


<br>

<p style="margin-top: 0px;" >
<button onclick="serialize();">Apply</button>
</p>

<form action="http:restore.cgi" method="POST" name="dflts" id="dflts" onsubmit="return get_resp()">
<input type="hidden" name="dflt" id="dflt" value="scaling"/>
<input type="submit" name="restore" value="Restore Defaults" /></form>
</div>
<div class="pagebox"><div id="footer"></div></div>
</body></html>
