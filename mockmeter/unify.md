# Unify branch notes

Research into viability of consolidating all three (Mx50, Dx50, Mx60) of the web
 page source code folders into one.  Expecting to use gulp.js for automation.

## Workflow

(wip) Edit html and js files in the mockmeter repository.  Package with gulp and
 serve up with CherryPy for testing.  We will treat the 'web app' as a library
 for the firmware, so we will only need to transfer or import the `tfs_data.h`
 and `tfs_data.c` files.  Optionally, may want to also transfer `manifest.json`.

The gulp build process will use the following folder structure within mockmeter:  
`web_pages/dx50/bld`  
`web_pages/mx50/bld`  
`web_pages/mx60/bld`  

Within each `bld` folder, a destination.json file defines where to copy the
 processed static files and the tfs_data files.  The former are for use by mockmeter
 and latter for the firmware.  The `web_pages` folder holds files common to all
 builds, while the subfolders hold product specific files.

In the conf file, setting [device]/devmode True will change the mock server to
 use the unprocessed files.  This allows in place editing for convenience during
 web development.

> When does `rtcs.a` get transferred from mqx to our projects?

If it's transferred by the library build, then this isn't any different even if
 we automatically build all three variations at once.  Still, the problem with
 that is 2.5s becomes 7.5s and you're probably only interested in one at a time.

> Build all three at once or have option to specifiy via cli arg or config?

## Comparisons

### General

- needs mechanism to define and include disjoint sets of files
- consider making index.html not cacheable

### Handling root index for firmware updates

- Change to serve root and index with header  `'Cache-control' = 'no-store'`.
  Done for mock and D650 firmware (`httpd_supp.c`).  Need for Mx50, Mx60.
- Added a version parameter to page redirects occuring on reboot.  (`cgi_web.c`)
  The effect is redundant to disabling caching above.
- Increased wait time on firmware reboot to 20 secs (`cgi_web.c`)
- Added an alias for `index1.html` to asset revisioned name. (`RTCS.C`)
- D650 logo banner is now clickable for root.  Add this to other products (`content.js`)

The combination of the above should quickly get the web client back on the correct
 set of files under any circumstances.  Typical scenario is a firmware update where
 the page redirect on reboot should suffice.  More challenging is a 'meter swap'
 at the same IP.  Clicking the banner, the web page home tab, or browser refresh
 will load the right files.  However, an upgrade from firmware without these changes
 to firmware with the changes will require the user to do a browser refresh.

### Mx50 vs Mx60

- `auth.html`
  - Mx50 adds a radio button for a third lock option.  Need to migrate
 feature to the Mx60 and may need to check backend.
- `config.html`
  - Mx60 adds runtime check for Trend option to post message  
  - References model specific filename, e.g. mx50.cfg
  - Other minor text differences easily reconciled
- `content.js`
  - Mx60 (also Dx50) adds status tab.
- `cregs.js`
  - Mx60 adds Binary Outputs
  - Mx60 adds search filters
  - Mx60 adds some questionable calctype name handling
- `css_tabs.css`
  - ?
- `data.html`
  - different tables for measurement inclusion
  - Mx60 adds power supply monitoring
  - Mx60 adds vector, sync, and trend tabs
- `data.js`
  - changes to `check_status()` ?
  - Mx60 adds health flag decoding
  - Mx60 adds `check_connects()`
- `data2.html`
  - similar to `data.html`
- `dnpBilf.js`
  - changes?  health dbidx and counter calc types
- `dnpDatalog.js`
  - same changes as `dnpBilf.js`
  - Mx60 adds measurements of course
  - catalogs should be autogenerated and the challenge will be
    - handling the classification of different dnp types but need this for D650
    - change measurement key from index to enums, add compression?
- `identity.html`
  - trivial wording change
- `index.html`
  - different file load list, see #general above
- `index1.html`
  - needless insertion of a newline
- `input.html`
  - table changes for validation and inclusion.  schema?
  - changes to `parse_vars()`
  - Mx60 adds kyz and outputs.  This isn't really the right place.
  - Mx60 adds bus2 pts.  Could manually inject or use jQuery $().load()
- `load.js`
  - changes to `startUpload()`
  - unnecessary message change, revise.
- `mb*.js`
  - same issues as dnp
- `network.html`
  - trivial css change, needs fixing
- `output.html`
  - trivial text change
- `protocol.html`
  - whitespace only
- `protocol.js`
  - changes to `parse_vars()`
  - some likely only formatting changes
  - changes to serial port handling
- `protocol1.html`
  - alternate primary units scaling options
  - changes to confirm restore defaults
  - lots of trivial formatting changes
  - Mx60 adds filtering
- `recover.html`
  - trivial text changes
- `resets.html`
  - Mx60 adds peak fault resets
  - some text and formatting changes
- `scrnena.html`
  - white space only
- `serport.html`
  - MX60 adds multiple new options, gets complicated
  - may need to use work from Mx60/PPX merge
- `settings.html`
  - Mx60 adds new protocols, trend
  - more serial port issues
- `site.css`
  - trivial
- `tuc.js`
  - only measurement names, but Dx50 merge will remove
- `upload.html`
  - different max file size allowance
  - trivial text changes
